<!DOCTYPE html>
<!--CREATED 23.02.2025 AT 09:45--><?
const {importHead}=globals.functions;
const blog=service_require("blog/blog");
//const articles=blog.getArticles();

if(input.action==="save"){
	const now=Date.now();
	const lastArticle=blog.getSavedArticle()||{};
	const lastEdit=input.articleText===lastArticle.articleText?lastArticle.lastEdit:now;
	const created=(!lastArticle.articleText&&!lastArticle.description&&!lastArticle.title)?now:lastArticle.created;
	const article=blog.getArticleTemplate({
		...lastArticle,
		id: 0,
		title: input.title||"",
		description: input.description||"",
		visibility: input.visibility||"everyone",
		articleText: input.articleText||"",
		lastEdit,
		created,
	});
	for(let index=0; index<article.files.length; index+=1){
		const file=article.files[index];
		const keepFile=input["file"+index]==="on";
		if(!keepFile){
			await blog.removeFileFromSavedArticle(file);
			article.files=article.files.filter(item=>item!==file);
		}
	}
	blog.setSavedArticle(article);
	if(input.file.filename!==""&&!article.files.includes(input.file.filename)){
		await blog.addFileToSavedArticle(input.file.filename,input.file.data);
		delete input.file.data; // for debugging not crashing my browser because of the large buffer
	}
}
else if(input.action==="post-saved"){
	const now=Date.now();
	let article={
		...blog.getSavedArticle(),
		id: now,
		folder: "saved",
	};
	if(!article.title||!article.description||!article.articleText){
		const url="?err=article_requirements_missing&view=create";
		response.setHeader("Location",url);
		throw 302;
	}
	article=blog.createArticle(article);
	blog.setSavedArticle(blog.getArticleTemplate({id:0,folder:"saved"}));

	const url="/blog/article.html?id="+now;
	response.setHeader("Location",url);
	throw 302;
}

?>
<html>
<head>
	<?=importHead({
		input,
		tabs: 1,
		title: "Blog-Artikel Erstellen und Bearbeiten",
		botIndexAllow: false,
	})?>
</head>
<body>
<?
	if(!input.view||input.view==="main"){
?>	<h1>Blog-Artikel Erstellen oder Bearbeiten, Bitte auswählen!</h1>
	<ul>
		<li>Ich Möchte einen Artikel <a href="?view=create">Erstellen</a>.</li>
		<li>Ich Möchte einen vorhandenen Artikel <a href="?view=edit">Bearbeiten</a>.</li>
	</ul>
<?
	}else if(input.view==="create"){
?>	<h1>Neuer Blog-Artikel</h1>
<?
		const savedArticle=blog.getSavedArticle();
		if(savedArticle&&input.action==="save"){
?>	<p><span style=color:gold>INFO</span>: Artikel Zwischengespeichert!</p>
<?
		}
		if(input.err){
			let error=input.err;
			let message="";
			let critical=0;
			switch(error){
				case "article_requirements_missing":
					message="Es Fehlen Informationen, bitte ergenzen!";
					break;
				default:
					message="Es ist ein Unbekannter fehler aufgetreten!";
					error="unkown_error";
					critical=2;
					break;
			}
			let color="";
			let text="";
			if(critical===0){color="gold";text="INFO";}
			else if(critical===1){color="orange";text="WARNING";}
			else if(critical===2){color="red";text="ERROR";}
?>	<p title=<?=error?>><span style=color:<?=color?>><?=text?></span>: <?=message?></p>
<?
		}
?>	<form id=form method=post enctype=multipart/form-data>
		<input type=hidden name=view value=create>
		<input type=hidden name=action value=save>
		<p>Titel: <input type=text name=title required autocomplete value="<?=savedArticle.title||''?>"></p>
		<p>Beschreibung: <input type=text name=description required autocomplete=off value="<?=savedArticle.description||''?>"></p>
		<p>Sichtbarkeit: <select name=visibility required>
			<option value=everyone<?=savedArticle.visibility==='everyone'?' selected':''?>>Alle</option>
			<option value=logined<?=savedArticle.visibility==='logined'?' selected':''?>>Angemeldet</option>
			<option value=rank-blog<?=savedArticle.visibility==='rank-blog'?' selected':''?>>Blog-Rank</option>
			<option value=rank-blog-extra<?=savedArticle.visibility==='rank-blog-extra'?' selected':''?>>Blog-extra-Rank</option>
			<option value=owner<?=savedArticle.visibility==='owner'?' selected':''?>>Admins</option>
		</select></p>
		<p>Datei<?=savedArticle.files.length===1?'':'en'?> <?=savedArticle.files.length>0?savedArticle.files.length:'Keine'?></p>
<?
		if(savedArticle.files.length>0){
?>		<ul>
<?
		for(let index=0; index<savedArticle.files.length; index+=1){
			const name=savedArticle.files[index];
?>			<li><span><input type=checkbox name=file<?=index?> checked> <?=name?></span></li>
<?
		}
?>		</ul>
<?
		}
?>		<input type=file name=file>
		<p><textarea name=articleText><?=savedArticle.articleText||''?></textarea></p>
		<p>Aktionen: 
			<input type=submit value="Artikel zwischenspeichern" title="Speichert auf Server" onclick="document.getElementById('form').action.value='save';">
			<input type=submit value=Vorschau title="Zeigt eine vorschau des Artikels wie vorm ausdrucken eines Dokuments." onclick="document.getElementById('form').view.value='create-preview';">
		</p>
<?
		if(input.action==="load"||true){ // old if state i shoud remove that condition
?>		<script>
			if(history.replaceState) history.replaceState(null,"","?view=create");
			document.addEventListener("visibilitychange",event=>{
				if(document.visibilityState!=="hidden"||!window.autosave) return;
				var form=document.getElementById("form");
				form.action.value="save";
				form.view.value="create";
				form.submit();
			});
		</script>
<?
		}
?>	</form>
<?
	}
	else if(input.view==="create-preview"){
		const article=blog.getSavedArticle();
		if(!article.title||!article.description){
			const url="?err=article_requirements_missing&view=create";
			response.setHeader("Location",url);
			throw 302;
		}
		if(!article.articleText) article.articleText=await blog.getArticleText(article.id);
?>	<script>
		if(history.replaceState) history.replaceState(null,"","?view=create-preview");
	</script>
	<h1><a href=//lff.one>LFF.ONE</a>/<a href=/blog>BLOG</a></h1>
	<h2><?=article.title?></h2>
	<p><b>Erstellt</b>: <i><?=new Date(article.created).toLocaleString()?></i></p>
	<h3 title=Beschreibung><?=article.description?></h3>
	<br>
	<div class=article><?=article.articleText?></div>
	<br>
	<p><i>Stand vom: <?=new Date(article.lastEdit).toLocaleString()?></i></p>
	<hr>
	<form method=put>
		<input type=hidden name=action value=post-saved>
		<input type=submit value=Veröffentlichen>
	</form>
	<form method=get>
		<input type=hidden name=view value=create>
		<input type=submit value=Bearbeiten>
	</form>
<?
	}
	else if(input.view==="edit"){
		// blog edit view
	}
	else if(input.view==="submit"){
?>	<p>SUBMIT!!</p>
<?
	}

	if(input.method==="post"){
		delete input.body;
?>	<p>METHOD POST INPUT</p>
	<p>
		<textarea><?=JSON.stringify(input,null,4)?></textarea>
	</p>
<?
	}
?></body>
</html>